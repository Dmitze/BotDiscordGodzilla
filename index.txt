const { Client, GatewayIntentBits, Routes, REST } = require('discord.js');
const fetch = require('node-fetch');

// Створюємо клієнта бота
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// URL до твого Google Apps Script
const API_URL = 'https://script.google.com/macros/s/AKfycbzLbmHd4aCtHME1x3EJ5v-WbBKsiPcL3H1MCumqMQEVpNdAJEi3apEDy7uAcGsEBRZZ/exec'; 

// Команди
const commands = [
  {
    name: 'дані',
    description: 'Отримати дані з таблиці',
  },
];

// Коли бот запущений
client.once('ready', async () => {
  console.log(`Бот ${client.user.tag} онлайн!`);

  // Реєструємо команди
  const rest = new REST({ version: '10' }).setToken('YOUR_DISCORD_BOT_TOKEN');
  await rest.put(Routes.applicationCommands(client.user.id), { body: commands });

  console.log('Команди зареєстровані!');
});

// Обробка slash-команд
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isChatInputCommand()) return;

  if (interaction.commandName === 'дані') {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();

      const headers = data[0]; // перший рядок - заголовки
      const rows = data.slice(1); // решта - записи

      let output = '**Дані з таблиці:**\n';
      for (let i = 0; i < Math.min(5, rows.length); i++) {
        const row = rows[i];
        output += `\n• ${headers[6]}: ${row[6]} | Ціна: ${row[4]} | Кількість: ${row[3]}`;
      }

      await interaction.reply(output);
    } catch (err) {
      console.error(err);
      await interaction.reply('Помилка при отриманні даних.');
    }
  }
});

// Логін бота
client.login('https://discord.com/oauth2/authorize?client_id=1380911700672385198&permissions=2147551232&response_type=code&redirect_uri=http%3A%2F%2Flocalhost&integration_type=0&scope=bot+applications.commands.permissions.update');